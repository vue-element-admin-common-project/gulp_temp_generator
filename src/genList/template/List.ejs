<!-- 搜索 FIXME 进行 修改 -->
<% var datepicker = __genTemp.DateDurationPicker %>
<% var rightBtnsBar = __genTemp.RightBtnsBar %>
<% var filBarCon = filterBarConfig %>
<% var tableCon = tableConfig %>
<% var hasRightBtnsBar = rightBtnsBar && rightBtnsBar.length %>
<% var hasOperationBtns = tableCon.operationBtns && tableCon.operationBtns.items %>
<% var hasSwitchToggle = tableCon.columns.some(i => i.type == 'switchBtn') %>
<template>
  <div class="<%=__genTemp.wrapClass%>">
<% if (datepicker) { %>
    <DateDurationPicker @dateChange="dateChange" />
<% } %>
<% if (filBarCon.length) { %>
    <!-- 搜索栏 -->
    <FilterBar :config="filterBarConfig" @clickSearch="clickSearch" />
<% } %>
<% if (hasRightBtnsBar) { %>
    <!-- 偏右 功能按钮条 -->
  <%
  var string = ''
  for (let i = 0, l = rightBtnsBar.length; i < l; i++) {
    var item = rightBtnsBar[i]
    string += `{ type: ${item.type || ''}, clickName: ${item.clickName || ''}, word: ${item.word || ''} }`
  }
  string = "[" + string + "]"
  %>
    <RightBtnsBar :config="<%= string %>" @clickBtn="clickRightBtn" />
<% } %>
    <!-- 表格 -->
    <NormalTable :list="list" :config="tableConfig" :pending="listPending"
                 <%if (tableCon.selection) {%>:selection.sync="listSelection"<% } %>
                 <%if (hasSwitchToggle) { %>@switchToggle="switchToggle"<% } %>
                 <%if (hasOperationBtns) { %>@operationBtnsClick="operationBtnsClick"<% } %>
                 />
    <!-- 分页 -->
    <div style="display: flex;justify-content: flex-end;">
      <Pagination :total="reqParam.total" :page.sync="reqParam.page"
                  :limit.sync="reqParam.limit" @pagination="getList" />
    </div>
  </div>
</template>

<script>
<% if (datepicker) { %>import DateDurationPicker from '@pro_common/components/DateDurationPicker/DateDurationPicker.vue'<% } %>
<% if (filBarCon.length) { %>import FilterBar from '@pro_common/components/FilterBar/FilterBar.vue'<% } %>
<% if (hasRightBtnsBar) { %>import RightBtnsBar from "@pro_common/components/RightBtnsBar/RightBtnsBar.vue"<% } %>
import NormalTable from '@pro_common/components/Tables/NormalTable.vue'
import Pagination from '@pro_common/components/Pagination/Pagination.vue'
import {<%if(filterBarConfig.length) { %> filterBarConfig,  <% } %>tableConfig} from './configs'
import deepClone from "@pro_common/utils/deepClone";
import filterReqCreator from "@pro_common/utils/filterReqCreator";
// import format10Ts2Txt from "@pro_common/utils/format10Ts2Txt";
import { FIXME_REQUEST } from "@/api/FIXME_REQUEST_PATH";

const EMPTY_REQ_PARAM = {
<% for (let i = 0, l = filBarCon.length; i < l; i++) { %>
  <%= filBarCon[i].valueKey %>: '', // TODO 待修正
<% } %>
<% if (datepicker) { %>
  <%= datepicker[0] %>: null, // 开始时间
  <%= datepicker[1] %>: 0, // 结束时间
<% } %>
}

export default {
  name: "<%=__genTemp.componentName%>",
  data() {
    return {
      list: [],
      listPending: false,
      // 表格配置
      tableConfig: deepClone(tableConfig),
      <% if(tableCon.selection) { %>listSelection: [], // 列表中选中项<% } %>
      reqParam: {
        page: 1, // 页数 前端 从1开始
        limit: 10, // 条数
        total: 0, // 总条数
        ...EMPTY_REQ_PARAM
      },
  <%  if (filBarCon.length) { %>
      // 搜索栏配置
      filterBarConfig: deepClone(filterBarConfig),
  <% } %>
    }
  },
  methods: {
    async getList() {
      this.listPending = true
      try {
        const {data} = await FIXME_REQUEST({
          start: (this.reqParam.page - 1) * this.reqParam.limit,
          pageSize: this.reqParam.limit,
          ...filterReqCreator(EMPTY_REQ_PARAM, this.reqParam)
        })
        const { list, total } = data
        list.forEach(item => { // FIXME 需要转换的字段
          // item.createdTxt = format10Ts2Txt(item.created, '{yyyy}-{mm}-{dd}')
        })
        this.list = list
        // 修改分页数据
        this.reqParam.total = total
      } catch (e) { // 错误 则清空 列表
        console.log(e)
        this.list = []
        this.reqParam.total = 0
      } finally {
        this.listPending = false
      }
    },
<% if (filBarCon.length) { %>
    clickSearch(obj) {
      Object.keys(obj).forEach(key => {
        this.reqParam[key] = obj[key]
      })
      // 重置分页
      this.reqParam.page = 1
      this.reqParam.total = 0
      this.getList()
    },
<% } %>
<% if (datepicker) { %>
    dateChange(date) {
      if (date === null) {
        this.reqParam.<%= datepicker[0] %> = EMPTY_REQ_PARAM.<%= datepicker[0] %>
        this.reqParam.<%= datepicker[1] %> = EMPTY_REQ_PARAM.<%= datepicker[1] %>
      } else {
        this.reqParam.<%= datepicker[0] %> = Math.floor(date[0].getTime() / 1000)
        this.reqParam.<%= datepicker[1] %> = Math.floor(date[1].getTime() / 1000)
      }
      this.reqParam.page = 1 // 页数重置
      this.reqParam.total = 0
      this.getList()
    },
<% } %>
<% if (hasOperationBtns) { %>
    async operationBtnsClick(clickName, row) {
    },
<% } %>
<% if (hasSwitchToggle) { %>
    async switchToggle(key, row) {
    },
<% } %>
<% if (rightBtnsBar && rightBtnsBar.length) { %>
    clickRightBtn(clickName) {
    },
<% } %>
  },
  async mounted() {
    this.getList()
  },
  components: {
    <% if (datepicker) { %>DateDurationPicker,<% } %>
    <% if (filBarCon) { %>FilterBar,<% } %>
    <% if (hasRightBtnsBar) { %>RightBtnsBar,<% } %>
    NormalTable,
    Pagination
  }
}
</script>

<style lang="scss" scoped>
.<%= __genTemp.wrapClass %> {
  box-sizing: border-box;
  padding: 20px;
}
</style>
